#!/usr/bin/env ruby

require 'rbbt-util'
require 'rbbt/workflow'
require 'rbbt/util/simpleopt'
require 'rbbt/util/semaphore'

options = SOPT.get("-wd--workdir* Workdir:-c--cpus* Number of cpus:-h--help Help")

if options[:help]
  puts SOPT.doc
  puts <<-EOF

# GenomicTools Update

This tool updates the system by running all the missing jobs in the pipeline.
For a given `workdir` it finds all uploaded files and calls for them the default pipeline,
which is enacted by the `all` task. The `all` task should depend on all the workflow tasks
that need to be ran by default.

  EOF
  exit 0
end

Workflow.require_workflow "GenomicTools"

GenomicTools.workdir = File.expand_path(options[:workdir] || '/home/mvazquezg/git/sandbox/data_portal/CNAG')

cpus = (options[:cpus] || 2).to_i

require 'parallel'
GenomicTools.nested_workflows.each do |workflow|
  Log.info Log.color(:magenta, "Processing #{ workflow }")
  samples = GenomicTools.all_workflow_authoritative_sample_files(workflow).keys
  Log.info Log.color(:magenta, "Samples: #{samples.length}")

  Parallel.each(samples, :in_processes => cpus) do |sample|
    Log.info Log.color(:blue, "Processing " << sample)
    begin
      job = workflow.job(:all, sample)
      job.run
      Log.info Log.color(:green, "DONE " << sample)
    rescue
      Log.info Log.color(:red, "ERROR " << sample)
      Log.exception $!
    end
  end
end
